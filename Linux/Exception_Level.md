# 익셉션 레벨이란?

![image](https://github.com/Ohjiwoo-lab/TIL/assets/74577768/54b0bad4-20f6-4bcb-bd13-8a7c52dc9bd6)   
출처: [[Arm프로세서] Armv8 익셉션 레벨: 하이퍼바이저 콜](https://blog.naver.com/crushhh/222487763252)

익셉션 레벨은 Armv8 아키텍처에서 사용하는 것으로, 프로세서의 권한 레벨을 나타낸다. EL0에서 EL3까지 총 4개의 익셉션 레벨이 존재하고 프로세서는 하나의 익셉션 레벨에서 동작한다. 익셉션 레벨 별로 수행할 수 있는 동작이 제한되어 있다. 만약 사용자 애플리케이션이 시스템의 민감한 부분까지 모두 제어할 수 있으면 큰 혼란이 발생할 수 있기 때문에 이를 제한하기 위한 것이다. 각 익셉션 레벨에서 할 수 있는 작업은 다음과 같다.

1. EL0

    흔히 User 모드라도 불리는 레벨로, 사용자 애플리케이션이 실행된다. unprivileged 레벨 또는 PL0로 실행되어 하드웨어에 직접 접근이 불가능하다. 따라서 EL0에서는 인터럽트, MMU, 캐시 기능을 설정할 수 없다.

2. EL1

    이는 흔히 커널 모드라고 불리는 레벨로, 리눅스 커널이 실행된다. PL1 권한으로 실행되기 때문에 인터럽트, MMU, 캐시 설정과 같은 시스템 설정이 가능하다. 사용자 애플리케이션에서 이러한 설정이 필요한 경우에는 시스템 콜을 통해 EL0에서 EL1으로 전환한 후 처리한다.

3. EL2

    일반적으로 하이퍼바이저가 실행되는 레벨로, PL2 권한으로 실행되어 게스트 OS끼리 스위칭하고 게스트 OS의 시스템 리소스에 접근이 가능하다.

4. EL3

    가장 높은 실행 권한을 가지는 레벨로 보통 트러스트존 아키텍처에서 시큐어 모드와 논시큐어 모드를 구분하기 위해 사용된다. 해당 익셉션 레벨에서는 모든 시스템에 대한 설정이 가능하기 때문에 부팅 시에 EL3로 설정된다.

> EL0와 EL1은 반드시 필요하지만, EL2는 가상화 환경인 경우에만, EL3는 트러스트존 아키텍처인 경우에만 필요하다.

EL0에서 동작 중인 사용자 애플리케이션에서 하드웨어의 접근이 필요한 경우 EL1으로 전환되어야 하며, EL1이라 하더라도 하이퍼바이저 관련 레지스터, 시큐어 관련 레지스터를 사용하는 경우에는 EL2, EL3로 전환되어야 한다. 이런 식으로 프로그램을 실행하기 위해 익셉션 레벨 간 전환이 빈번하게 일어난다. 대표적인 익셉션으로 시스템 콜이 있다. 사용자 애플리케이션에서 운영체제의 기능을 통해 하드웨어에 접근하려면 시스템 콜을 호출해야 한다. 그러면 내부적으로 `svc` 명령어를 실행하여 익셉션 레벨을 EL0에서 EL1으로 전환하게 되고, EL1에서 익셉션을 처리한다. 추가로 EL2와 EL3로 전환하기 위해서는 각각 `hvc` 명령어와 `smc` 명령어를 실행해야 한다.

익셉션을 처리할 때에는 `익셉션 벡터 테이블`을 이용한다. 익셉션 레벨 별로 익셉션 벡터 테이블이 존재하고, 익셉션이 발생하면 해당 익셉션 벡터 테이블을 이용하여 특정 위치로 분기 한 뒤 미리 정의되어 있는 코드를 실행하여 익셉션을 처리하게 된다. 하지만 EL0에서는 수행할 수 있는 작업이 거의 없기 때문에 익셉션이 발생하더라도 처리할 수 없다. 그래서 EL0에 대한 익셉션 벡터 테이블은 EL1에 정의되어 있으며, 익셉션이 발생하면 EL1으로 스위칭된 후 처리된다.

이렇게 익셉션을 처리하기 위해 실행되는 코드를 `익셉션 핸들러`라고 하며 소프트웨어적으로 구현된다. 원하는 동작을 수행하도록 커스터마이징할 수 있는데, 예를 들어 메모리 어보트 같은 익셉션이 발생했을 때 해당 익셉션을 발생시킨 애플리케이션을 종료하는 시그널을 보내도록 핸들러 코드를 구성할 수 있다.

# History

📌 2024-5-29: Arm 아키텍처에서의 익셉션 레벨 정리   