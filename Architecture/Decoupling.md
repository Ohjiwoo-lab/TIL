# Decoupling이란?

Decoupling은 시스템 간의 영향을 최소화하는 것을 말한다.

만약 주문을 받는 주문시스템과 주문이 들어오면 사용자에게 메일을 보내는 시스템이 있다고 가정해보자.

![image](https://github.com/Ohjiwoo-lab/TIL/assets/74577768/53e36c87-a91b-44ed-a958-cae8beb0d3b6)

두 시스템이 위와 같이 바로 연결되어 있다면 어떤 불편한 점이 있을까?

1. 주문 시스템의 일부분이 변경된다면?

    주문 시스템이 변경되면 이와 밀접하게 연결되어 있는 메일 시스템 또한 변경되어야 할 것이다.

2. 주문이 들어왔을 때 DB에 정보를 삽입하는 시스템이 추가된다면?

    ![image](https://github.com/Ohjiwoo-lab/TIL/assets/74577768/541038bd-9418-4984-93e6-2c0d6af87c4b)

    기존에는 메일 시스템으로만 요청을 보내면 되었지만, 이제 DB 삽입 시스템으로도 요청을 보내야 하기 때문에 주문 시스템의 로직이 변경되어야 한다.

이처럼 여러 시스템이 직접적으로 연결되어 있다면 하나의 시스템에 변경이 있을 때마다 전체 시스템이 영향을 받을 수 밖에 없다. 그래서 `Decoupling` 기법을 사용하여 영향을 최소화하는 것이 좋다.

## AWS에서 Decoupling을 구현하는 방법

AWS에서 Decoupling을 구현하는 방법에는 SQS와 SNS 서비스가 있다. SQS는 메시지 큐 서비스로, 1개의 메시지를 1개의 시스템으로 전달하는 것을 보장한다. 이와 반대로 SNS는 구독-발행 기반 서비스로, 1개의 메시지를 여러 시스템으로 전달하는 특징이 있다. 이러한 구조를 Fan-out 이라고 한다.

![image](https://github.com/Ohjiwoo-lab/TIL/assets/74577768/ddc94d7c-3d17-4573-8c8e-b04be13ea9a9)

위의 시스템에 Decoupling을 적용해본다면, 다음과 같을 것이다. SNS 서비스는 SNS 토픽을 구독하고 있는 모든 서비스에 메시지를 보내준다. 여기서는 1개의 주문에 대해서 메일도 보내고 DB 삽입도 진행할 것이기 때문에 SNS를 사용하였다. 만약 주문이 들어오면, 이를 구독하고 있던 메일 시스템과 DB 삽입 시스템은 알림을 받게 될 것이고, 이에 따라 부여된 작업을 수행할 것이다. 이러한 아키텍처를 구축하게 되면, 주문 데이터를 토대로 분석을 진행하는 시스템이 새롭게 추가된다 하더라도 주문 시스템은 아무런 영향을 받지 않을 것이다. 손쉽게 시스템을 확장해나갈 수 있다는 장점이 있다.

그러면 SQS는 언제 사용할까?

![image](https://github.com/Ohjiwoo-lab/TIL/assets/74577768/6126dd87-e629-4f68-be1b-7dabfb84242d)

만약 주문이 너무 많이 들어와서 메일 시스템을 여러 개 사용해야 하는 상황이라고 해보자. 그러면 SNS 예시처럼 하나의 메시지를 여러 시스템에서 처리하는 것이 아니라, 하나의 메시지를 한 번만 처리해야 할 것이다. 하나의 주문에 대해 여러 이메일을 받는다면 사용자는 불편함을 겪을 것이기 때문이다.

SQS 서비스는 메시지가 1번만 처리될 것을 보장해준다. SQS에 연결되어 있는 다수의 시스템 중 하나에서 메시지가 처리되고 있으면 다른 시스템은 해당 메시지에 접근할 수 없다.

이제 주문 시스템은 밀려 들어오는 주문을 단순히 SQS 큐에 넣기만 하면 되고, 메일 시스템은 큐에 들어있는 주문을 가져와서 처리하기만 하면 된다. 이는 주문 시스템과 메일 시스템 중 어느 하나가 변경되더라도 문제 없이 처리될 수 있으며, 메일 시스템이 더 추가되더라도 아무런 영향을 주지 않는다. 또한 쏟아져 들어오는 주문이 큐를 통해 관리되면 유실될 위험도 줄어들게 된다.

SNS와 SQS는 배타적인 서비스가 아니라 함께 사용될 수 있다. 각 서비스의 특징에 맞게 적절히 사용하면 된다.

이처럼 아키텍처를 설계할 때 `Decoupling`을 적용한다면 확장성이 좋고 안정적인 서비스를 만들 수 있을 것이다.

# History

📌 2024-3-5: Decoupling이란?   
📌 2024-3-16: 예시 이미지 및 설명 추가