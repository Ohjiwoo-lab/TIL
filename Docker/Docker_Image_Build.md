# 도커에서 이미지 빌드하는 방법

DockerHub에서 이미지를 가져와서 실행해도 되지만, 직접 이미지를 만들어서 실행할 수도 있다. 이미지를 만들기 위해서는 설정 파일인 Dockerfile을 생성해야 한다. 이미지는 애플리케이션을 실행하기 위해 `애플리케이션 파일 스냅샷`과 `컨테이너 시작 시 실행 명령어`를 포함한다고 했다. 따라서 Dockerfile은 이 2가지를 포함해야 한다.

먼저 파일 스냅샷을 정의하기 위해서는 다음과 같은 작업을 수행해야 한다.

1. 베이스 이미지를 명시한다.

2. 베이스 이미지 위에 추가로 필요한 모듈 및 설정을 진행하기 위한 명령어를 명시한다.

이때 베이스 이미지란 무엇일까? 도커 이미지는 여러 개의 레이어들로 구성되어 있다.

![image](https://github.com/Ohjiwoo-lab/TIL/assets/74577768/ce0695b6-1411-4fbf-85a4-ac68ea1c3955)   
출처: [도커 이미지 레이어 / 도커 허브 / 도커 계층(layer) / 도커의 장점 4가지](https://eunjinii.tistory.com/13)

여러 레이어 중에 기반이 되는 레이어를 `베이스 이미지`라고 하며, 베이스 이미지 위에 추가로 모듈이 설치되면서 레이어를 구성하게 된다. 그리고 이 전체 레이어의 집합이 하나의 이미지를 구성한다. 보통 베이스 이미지는 리눅스나 윈도우와 같은 OS라고 생각하면 된다.

Dockerfile에서 파일 스냅샷을 설정하기 위해 다음과 같이 작성할 수 있다.

```
FROM baseImage

RUN command
```

파일 스냅샷 외에도 컨테이너 시작 시 실행할 명령어도 명시해줘야 한다. 이는 다음과 같이 설정할 수 있다.

```
CMD ["executable"]
```

이를 바탕으로 실제로 간단한 Dockerfile을 작성해보자.

```
FROM alpine

CMD ["echo", "hello"]
```

이는 아주 경량화된 리눅스인 alpine 이미지를 베이스 이미지로 하고, 컨테이너 시작 시 `hello` 문자를 출력하도록 하는 간단한 애플리케이션이다. 해당 Dockerfile로 이미지를 빌드하기 위해서는 `build` 명령어를 사용해야 한다.

```
docker build -t jiwoo/hello ./
```

이렇게 하면 이름이 `jiwoo/hello`인 이미지가 생성된다.

![image](https://github.com/Ohjiwoo-lab/TIL/assets/74577768/e219bada-c97a-47b3-9c84-4e9669683dd3)

이미지가 빌드되는 과정을 살펴보면 `Removing intermediate container 3aa15847a835` 라는 부분이 있다. 이미지를 생성하기 위해 임시 컨테이너를 생성했다가 다시 삭제하는 과정이 포함된다는 것이다. build 명령어가 실행되면 이루어지는 작업은 다음과 같다.

1. 새로운 컨테이너가 생성된 후, CPU, 메모리, 네트워크, 하드 디스크를 할당한다.

2. 베이스 이미지의 애플리케이션 파일 스냅샷을 컨테이너의 하드 디스크에 저장한다.

3. 명시되어 있는 추가 모듈 설치 등의 작업이 진행된다.

4. Dockerfile에 명시되어 있는 시작 시 명령어를 이용하여 컨테이너에서 애플리케이션을 실행한다.

5. 이 컨테이너를 바탕으로 새로운 이미지를 생성한다.

6. 컨테이너를 삭제한다.

컨테이너는 이미지로부터 생성되었는데, 이미지도 컨테이너로부터 생성된다는 사실을 알 수 있다.

# Reference

[따라하며 배우는 도커와 CI환경](https://www.inflearn.com/course/%EB%94%B0%EB%9D%BC%ED%95%98%EB%A9%B0-%EB%B0%B0%EC%9A%B0%EB%8A%94-%EB%8F%84%EC%BB%A4-ci/dashboard)

# History

📌 2024-5-31: 도커 이미지 빌드 과정 정리   