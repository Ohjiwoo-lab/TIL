# ν…λΌνΌ κΈ°μ΄

## κµ¬μ„±μ”μ†

1. provider

- μƒμ„±ν•  μΈν”„λΌμ μΆ…λ¥λ¥Ό λ§ν•©λ‹λ‹¤. λ§μ•½ AWSμ μΈν”„λΌλ¥Ό κµ¬μ„±ν•λ ¤κ³  ν•λ©΄, providerλ” awsκ°€ λ  κ²ƒμ…λ‹λ‹¤.

- ν•΄λ‹Ή μ½”λ“λ¥Ό ν†µν•΄μ„λ” AWSμ λ¦¬μ†μ¤μ— μ ‘κ·Όν•κΈ° μ„ν• credentials λ“±μ νμΌμ„ λ‹¤μ΄λ°›λ” μ—­ν• μ„ μν–‰ν•©λ‹λ‹¤.

- μμ‹
    ```terraform
    provider "aws" {
        region = "ap-northeast-2"
        version = "~> 3.0"
    }
    ```

2. resource

- μ‹¤μ λ΅ μƒμ„±ν•  μΈν”„λΌμ μμ›μ„ λ…μ‹ν•©λ‹λ‹¤.

- .tf ν™•μ¥μλ¥Ό κ°€μ§‘λ‹λ‹¤.

- μμ‹
    ```terraform
    resource "aws_vpc" "example" {
        cidr_block = "10.0.0.0/16"
    }
    ```
    - AWSμ VPCλ¥Ό μƒμ„±ν•λ” μ½”λ“μ…λ‹λ‹¤.
    - cidr_block μ™Έμ—λ„ μ„¤μ •ν•  μ μλ” Argumentκ°€ λ‹¤μ–‘ν•κ² μ΅΄μ¬ν•©λ‹λ‹¤.
    - `example`μ€ μƒμ„±ν• VPCμ μ΄λ¦„μ…λ‹λ‹¤.

3. state

- μ‹¤μ λ΅ ν…λΌνΌ λ…λ Ήμ–΄λ¥Ό μ‹¤ν–‰ν•μ€μ„ λ• μƒμ„±λλ” κ²°κ³Όλ¬Όμ…λ‹λ‹¤.

- .tfstate ν™•μ¥μλ¥Ό κ°€μ§€λ” νμΌλ΅ μƒμ„±λ©λ‹λ‹¤.

- μ£Όμν•  μ μ€ state νμΌμ— μ €μ¥λ κ°’μ΄ μ‹¤μ  μΈν”„λΌ μμ›μ μƒνƒλ¥Ό μλ―Έν•λ” κ²ƒμ€ μ•„λ‹™λ‹λ‹¤. state νμΌκ³Ό μ‹¤μ  μΈν”„λΌ μƒνƒλ¥Ό λ™μΌν•κ² μ μ§€ν•λ” κ²ƒμ΄ μ¤‘μ”ν•©λ‹λ‹¤.

- μμ‹
    ```terraform
    {
        "version": 4,
        "terraform_version": "0.12.24",
        "serial": 3,
        "lineage": "3c77XXXX-2de4-7736-1447-038974a3c187",
        "output": {},
        "resources":[
            {...},
            {...}
        ]
    }
    ```
    - μ§€κΈμ€ ν•νƒλ§ λ³΄κ³  λ„μ–΄κ°€κ³  λ‚μ¤‘μ— λ‹¤μ‹ μμ„Έν•κ² μ‚΄ν΄λ³΄κ² μµλ‹λ‹¤.

4. output

- μƒμ„±ν• μμ›μ„ λ³€μ ν•νƒλ΅ state νμΌμ— μ €μ¥ν•λ” κ²ƒμ…λ‹λ‹¤.

- μ΄λ” remoteλ΅ μ°Έμ΅°λ  μ μμµλ‹λ‹¤.

- μμ‹
    ```terraform
    resource "aws_vpc" "example" {
        cidr_block = "10.0.0.0/16"
    }

    output "vpc_id" {
        value = aws_vpc.example.id
    }

    output "cidr_block" {
        value = aws_vpc.example.cidr_block
    }
    ```
    - μ΄μ „μ— μƒμ„±ν• VPCμ idμ™€ cidr_blockμ„ κ°€μ Έμ™€μ„ λ³€μμ— μ €μ¥ν•λ” μμ μ…λ‹λ‹¤.

5. module

- ν• λ² λ§λ“¤μ–΄μ§„ ν…λΌνΌ μ½”λ“λ¥Ό κ°™μ€ ν•νƒλ΅ λ°λ³µμ μΌλ΅ λ§λ“¤μ–΄λ‚Ό λ• μ‚¬μ©ν•©λ‹λ‹¤.

- μ¬μ‚¬μ©μ— κ°•μ μ΄ μμµλ‹λ‹¤.

- μμ‹
    ```terraform
    module "vpc" {
        source = "../_modules/vpc"

        cidr_block = "10.0.0.0/16"
    }
    ```
    - VPCλ¥Ό cidr_blockλ§ λ‹¤λ¥΄κ² ν•μ—¬ λ‹¤μ‹ μƒμ„±ν•΄μ•Ό ν•  λ• μ‚¬μ©λ  μ μμµλ‹λ‹¤.

6. remote

- λ‹¤λ¥Έ κ²½λ΅μ state νμΌμ—μ„ output λ³€μλ¥Ό λ¶λ¬μ¬ λ• μ‚¬μ©λ©λ‹λ‹¤. (μ›κ²© μ°Έμ΅°)

- μμ‹
    ```terraform
    data "terraform_remote_state" "vpc" {
        backend = "s3"

        config = {
            bucket = "terraform-s3-bucket"
            region = "ap-northeast-2"
            key = "terraform/vpc/terraform.tfstate"
        }
    }
    ```
    - s3 λ²„ν‚·μ— μ €μ¥λμ–΄ μλ” .tfstate νμΌμ„ μ°Έμ΅°ν•©λ‹λ‹¤.
    - key κ°’μ— λ…μ‹ν• state νμΌμ—μ„ λ³€μλ¥Ό κ°€μ Έμ¤λ” μμ μ…λ‹λ‹¤.
    - `vpc`λ” remoteμ κ³ μ ν• μ΄λ¦„μ„ μλ―Έν•©λ‹λ‹¤.
    
    ```terraform
    output "vpc_id" {
        value = aws_vpc.example.id
    }

    resource "aws_instance" "example" {
        vpc_id = data.terraform_remote_state.vpc.outputs.vpc_id
    }
    ```
    - μ‹¤μ λ΅ remoteλ¥Ό μ‚¬μ©ν•λ ¤λ©΄ λ‹¤μκ³Ό κ°™μ΄ μ‘μ„±ν•  μ μμµλ‹λ‹¤.
    - .tfstate νμΌμ— `vpc_id`λΌλ” output λ³€μκ°€ μλ‹¤λ©΄, μΈμ¤ν„΄μ¤λ¥Ό μƒμ„±ν•  λ•μ— remoteλ¥Ό μ΄μ©ν•μ—¬ λ¶λ¬μ¬ μ μμµλ‹λ‹¤.

7. backend

- state νμΌμ„ μ €μ¥ν•λ” κ³µκ°„μ„ μλ―Έν•©λ‹λ‹¤.

- λ€ν‘μ μΌλ΅ AWS S3κ°€ μμµλ‹λ‹¤.


## κΈ°λ³Έ λ…λ Ήμ–΄

1. init

- ν…λΌνΌμ λ…λ Ήμ–΄λ“¤μ„ μ‚¬μ©ν•κΈ° μ„ν•΄ μµμ΄μ— μ‹¤ν–‰λμ–΄μ•Ό ν•λ” λ…λ Ήμ–΄μ…λ‹λ‹¤.

- λ‚΄λ¶€μ μΌλ΅ providerμ™€ state, module λ“± κ°μΆ… μ„¤μ •μ΄ μ§„ν–‰λ©λ‹λ‹¤.

2. plan

- ν…λΌνΌμΌλ΅ μ‘μ„±λ μ½”λ“κ°€ μ‹¤μ λ΅ μ–΄λ–»κ² μμ›μΌλ΅ λ§λ“¤μ–΄μ§ μ§€μ— λ€ν• μμΈ΅ κ²°κ³Όλ¥Ό λ³΄μ—¬μ£Όλ” λ…λ Ήμ–΄μ…λ‹λ‹¤.

- μ‹¤μ λ΅ κ°€μ¥ λ§μ΄ μ‚¬μ©λλ” λ…λ Ήμ–΄μ…λ‹λ‹¤.

3. apply

- ν…λΌνΌ μ½”λ“λ¥Ό μ‹¤ν–‰ν•μ—¬ μ‹¤μ  μΈν”„λΌλ¥Ό μƒμ„±ν•λ” λ…λ Ήμ–΄μ…λ‹λ‹¤.

4. import

- μ΄λ―Έ λ§λ“¤μ–΄μ Έ μλ” μμ›μ„ μ½”λ“λ΅ λ§λ“¤μ–΄ state νμΌλ΅ μ®κ²¨μ£Όλ” λ…λ Ήμ–΄μ…λ‹λ‹¤.

- κΈ°μ΅΄μ— route53μ΄λΌλ” μμ›μ„ λ§λ“¤μ—λ‹¤κ³  κ°€μ •ν•λ©΄, μ΄λ¥Ό λ¶λ¬μ™€ μ‚¬μ©ν•  μ μλ‹¤λ” κ²ƒμ…λ‹λ‹¤.

5. state

- state νμΌμ„ λ‹¤λ£¨λ” λ…λ Ήμ–΄μ…λ‹λ‹¤. mv, pushμ™€ κ°™μ€ ν•μ„ λ…λ Ήμ–΄κ°€ μ΅΄μ¬ν•©λ‹λ‹¤.

6. destroy

- μƒμ„±λ μμ›μ„ state νμΌμ„ κΈ°μ¤€μΌλ΅ ν•μ—¬ λ¨λ‘ μ‚­μ ν•λ” λ…λ Ήμ–΄μ…λ‹λ‹¤.

- μ‚­μ ν•κ³  μƒλ΅­κ² λ§λ“¤κ³  μ‹¶μ€ κ²½μ°μ— μ‚¬μ©ν•©λ‹λ‹¤.


## λ…λ Ήμ–΄ μ‚¬μ© ν”„λ΅μ„Έμ¤

> ν…λΌνΌ μ½”λ“ μ‘μ„± -> init -> plan -> apply

λ³΄ν†µ λ‹¤μκ³Ό κ°™μ€ λ‹¨κ³„λ΅ μ§„ν–‰λ©λ‹λ‹¤. 

μ‹¤ν–‰ν•  ν…λΌνΌ μ½”λ“λ¥Ό μ‘μ„±ν•λ” κ²ƒμ΄ μλ°λμ–΄μ•Ό ν•©λ‹λ‹¤. 

κ·Έ ν›„μ— ν…λΌνΌ λ…λ Ήμ–΄λ“¤μ„ μ‚¬μ©ν•κΈ° μ„ν•΄ `init` λ…λ ΉμΌλ΅ ν™κ²½ μ„¤μ •μ„ ν•΄μ¤λ‹λ‹¤. 

κ·Έλ¦¬κ³  μ‹¤ν–‰ κ²°κ³Όλ¥Ό μμΈ΅ν•κΈ° μ„ν•΄ `plan` λ…λ Ήμ–΄λ¥Ό μ‚¬μ©ν•©λ‹λ‹¤. planμ κ²°κ³Όμ—μ„ μ¤λ¥κ°€ μ—†μ–΄μ•Ό μ‹¤μ λ΅ μ‹¤ν–‰ν–μ„ λ• μ¤λ¥κ°€ μ—†μ„ ν™•λ¥ μ΄ λ†’μµλ‹λ‹¤. ν•μ§€λ§ planμ΄ 100% μ¤λ¥κ°€ μ—†μμ„ λ³΄μ¥ν•΄μ£Όμ§€λ” μ•μµλ‹λ‹¤. μμΈ΅ κ²°κ³ΌμΌ λΏ ν•­μƒ μ¬λ°”λ¥΄κ² λ™μ‘ν•λ‹¤κ³  μ¥λ‹΄ν•  μλ” μ—†κΈ° λ•λ¬Έμ΄μ£ . 

κ·Έ ν›„μ— `apply`λ¥Ό ν†µν•΄ μ½”λ“λ¥Ό μ‹¤ν–‰ν•μ—¬ μμ›μ„ μƒμ„±ν•©λ‹λ‹¤. applyλ” μ‹¤μ λ΅ μΈν”„λΌμ— μν–¥μ„ λ―ΈμΉκΈ° λ•λ¬Έμ— μ‹¤ν–‰μ— μ μν•΄μ•Ό ν•λ©°, apply ν•κΈ° μ „μ— planμ„ ν•λ” μµκ΄€μ„ λ“¤μ—¬μ•Ό ν•©λ‹λ‹¤.

## ν…λΌνΌ μ‘λ™ μ›λ¦¬

ν…λΌνΌμ€ ν¬κ² 3κ°€μ§€λ΅ κµ¬μ„±λμ–΄ μμµλ‹λ‹¤.

1. λ΅μ»¬μ—μ„ μ‘μ„±ν• μ½”λ“
2. μ½”λ“λ¥Ό ν†µν•΄ λ§λ“¤μ–΄μ§„ μ‹¤μ  AWS μΈν”„λΌ
3. λ°±μ—”λ“μ— μ €μ¥λλ” state νμΌ

κ·Έλμ„ μ΄ 3κ°€μ§€ κµ¬μ„±μ”μ† κ°„μ νλ¦„μ„ μ΄ν•΄ν•μ—¬μ•Ό ν•©λ‹λ‹¤.

μ½”λ“λ¥Ό ν†µν•΄ λ§λ“¤μ–΄μ§€λ” μ‹¤μ  AWS μΈν”„λΌμ™€ λ°±μ—”λ“μ— μ €μ¥λ state νμΌμ΄ 100% μΌμΉν•λ„λ΅ λ§λ“λ” κ²ƒμ΄ μ¤‘μ”ν•©λ‹λ‹¤. λ§μ•½ state νμΌμ„ λ³€κ²½ν• ν›„ λ°μν–λ”λ° λ‹¤λ¥Έ κ°λ°μμ™€μ μ‹±ν¬κ°€ λ§μ§€ μ•κ±°λ‚, μƒμ„±λ AWS μΈν”„λΌλ¥Ό μ½μ†”λ΅ λ³€κ²½ν•λ ¤κ³  ν•κ±°λ‚, λ°±μ—”λ“μ— μ €μ¥λ stateλ¥Ό μ„μλ΅ λ³€κ²½ν•λ ¤κ³  ν•λ‹¤λ©΄ μΌμΉν•μ§€ μ•λ” κ²½μ°κ°€ μƒκΈΈ μλ„ μμµλ‹λ‹¤.

<hr/>

πƒ 2023-12-22 TIL   
πƒ 2023-12-25 TIL - ν…λΌνΌ μ‘λ™ μ›λ¦¬ μ¶”κ°€