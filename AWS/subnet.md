# 서브넷에서의 통신 방식

![image](https://github.com/Ohjiwoo-lab/TIL/assets/74577768/7926a57f-3f74-403a-8d74-1e110a539036)

AWS에서 제공하는 독립적인 네트워크 공간인 VPC에는 Public subnet과 Private subnet이 있다. 퍼블릭 서브넷의 경우 외부 인터넷과 통신할 수 있는 서브넷이지만, 프라이빗 서브넷은 외부와 통신할 수 없다.

퍼블릭 서브넷이 외부와 통신할 수 있게 하는 방법은 바로 인터넷 게이트웨이를 이용하는 것이다.

![image](https://github.com/Ohjiwoo-lab/TIL/assets/74577768/e327e1fe-c135-4dc3-87aa-fc557a24adf0)

이는 퍼블릭 서브넷의 라우팅 테이블이다. 만약 퍼블릭 서브넷에 위치한 인스턴스로부터 VPC 내부의 다른 서비스로 보내는 요청이 아닌 외부로 보내는 요청이라면 `인터넷 게이트웨이`를 통하도록 설정해놓았다. 이와 반대로 외부에서 퍼블릭 서브넷에 위치한 인스턴스로 요청이 들어올 경우도 마찬가지로 인터넷 게이트웨이를 통하여 요청이 전달된다.

> 퍼블릭 서브넷은 인터넷 게이트웨이가 연결된 서브넷을 뜻한다. 따로 퍼블릭 서브넷을 지정하는 것은 아니다.

그러면 프라이빗 서브넷은 아예 외부와 통신이 불가능할까? 그것은 아니다.

![image](https://github.com/Ohjiwoo-lab/TIL/assets/74577768/614d2df0-7cb8-4911-8db2-628b071efe1c)

이는 프라이빗 서브넷의 라우팅 테이블이다. 마찬가지로 외부로 보내는 요청의 경우 어떠한 것으로 라우팅하도록 설정되어 있는데, 이는 `NAT 게이트웨이`이다. NAT 게이트웨이는 퍼블릭 서브넷에 위치하고 있고, 프라이빗 서브넷의 요청을 외부로 전달하는 역할을 맡고 있다. NAT 게이트웨이 덕분에 프라이빗 서브넷의 인스턴스는 외부 인터넷과 통신할 수 있다.

그러면 외부에서는 프라이빗 서브넷으로 어떻게 요청을 보낼까?

그것은 `배스천 호스트`를 이용할 수 있다. 배스천 호스트는 퍼블릭 서브넷에 위치한 EC2 인스턴스로, 퍼블릭 IP를 가지고 있다. 그리고 프라이빗 서브넷의 인스턴스는 이 배스천 호스트로부터 오는 요청만을 허용한다.

그러면 외부에서 배스천 호스트의 퍼블릭 IP로 접속한 뒤, 배스천 호스트를 통해 프라이빗 서브넷으로 접속할 수 있다. 아무나 접속할 수 없도록 키 페어를 적절히 관리할 필요가 있다.

보안그룹은 다음과 같이 설정할 수 있다.

**배스천 호스트의 보안그룹**

![image](https://github.com/Ohjiwoo-lab/TIL/assets/74577768/27dad1d6-e987-4fae-95d9-24517a06512f)

- 모든 곳에서 SSH 접근을 허용한다.
- 대신 SSH를 위한 키 페어를 보안에 유의하여 관리해야 한다.

**프라이빗 서브넷에 위치한 인스턴스의 보안그룹**

![image](https://github.com/Ohjiwoo-lab/TIL/assets/74577768/4bab014d-6da5-4572-b3ca-2b58299e18ca)

- 배스천 호스트의 보안그룹에 해당하는 곳으로 부터 온 SSH 요청만을 허용한다.
- 위의 사진에서 소스 위치에 `sg-`로 시작하는 것이 배스천 호스트의 보안 그룹이다.
- 이렇게 하면 해당 인스턴스는 반드시 배스천 호스트를 거쳐야만 접속할 수 있다.

# History

📌 2024-2-12: 서브넷에서의 통신 방식 정리