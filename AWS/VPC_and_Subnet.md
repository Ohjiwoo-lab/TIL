# VPC란?

VPC란 Virtual Private Cloud의 약자로 AWS에서 제공해주는 가상 네트워크 망이다. 사용자는 VPC를 통해 독자적인 네트워크를 구성할 수 있다. VPC를 이루는 구성요소는 다음과 같다.

1. CIDR

    VPC는 CIDR을 기반으로 이루어져 있다. CIDR은 IP 주소의 블록을 말하는데, `192.168.0.0/26`의 형태를 이루고 있다. `192.168.0.0`이 CIDR 블록의 시작 IP주소이고, `/26`이 서브넷 마스크이다. 여기서 서브넷 마스크는 네트워크 주소의 비트수를 의미한다. 네트워크 주소는 특정 네트워크의 주소로 해당 네트워크에 속한 호스트가 모두 공통으로 가지는 값이다. 즉, 변하지 않는 값이라고 이해하면 빠를 것이다. 이와 반대로 호스트마다 가지는 값을 호스트 주소라고 한다.

    실제 예시를 가지고 살펴보자. `192.168.0.0`이라는 주소는 IPv4 주소 체계를 가지고 있으며 총 32비트로 이루어져 있다. 즉, `.`을 기준으로 나눠져 있는 숫자가 8비트로 이루어져 있는 것이다. 8비트로 표현할 수 있는 숫자는 0~255이기 때문에 최대 `255.255.255.255`까지의 수를 가질 수 있다. 이때 어느 수까지 가질 수 있는지를 정의하는 것이 서브넷 마스크이다. 예시에서는 `/26`이었으므로, 앞에서부터 26비트까지는 변하지 않는 값이다. 즉, 아래와 같은 모습일 것이다.

    ![image](https://github.com/Ohjiwoo-lab/TIL/assets/74577768/975b59f8-f6c0-4f87-b682-7f6b72f3971e)
    
    앞에서부터 26비트를 변하지 않는 값 `네트워크 주소`라 하고, 그 뒤에 나멈지 6비트를 변하는 값 `호스트 주소`라고 한다. 6개의 비트로 표현할 수 있는 값은 0~63으로, 총 64개이다. 따라서 `192.168.0.0/26`의 IP 주소 범위는 `192.168.0.0`~`192.168.0.63`일 것이다. 서브넷 마스크를 통해 네트워크의 범위를 조절할 수 있다. 값이 커질 수록 네트워크 범위가 줄어들게 될 것이다. VPC에서는 `/28`~`/16`까지의 서브넷 마스크 값을 가질 수 있다.

    이렇게 VPC가 가질 수 있는 IP 주소의 범위를 정의하는 것이 CIDR이고, VPC뿐 아니라 이후 살펴볼 서브넷, 보안 그룹, 라우팅 테이블에서 모두 적용되는 개념이다. VPC가 가상 사설 클라우드이기 때문에 사용할 수 있는 CIDR은 모두 프라이빗 IP 주소 범위여야 한다. 사용가능한 프라이빗 IP 주소 범위는 다음과 같다.

    - 10.0.0.0/8 (10.0.0.0~10.255.255.255)
    - 172.16.0.0/12 (172.16.0.0~172.21.255.255)
    - 192.168.0.0/16 (192.168.0.0~192.168.255.255)

2. 서브넷

    VPC는 여러 개의 서브넷으로 구분된다. 서브넷은 VPC의 특정 IP 주소 범위를 의미하는데, 연결되어 있는 라우팅 테이블에 따라 퍼블릭 서브넷과 프라이빗 서브넷이 존재한다.

    > 이후에 두 서브넷의 차이를 자세히 알아볼 것이다.

    서브넷은 특정 가용영역에 포함되어 있으며, 여러 개의 가용영역에 걸쳐 생성하는 것은 불가능하다. 서브넷도 CIDR로 정의하는데, 당연하게도 VPC의 CIDR의 부분집합일 것이다. 서브넷에 정의한 CIDR 범위에서 처음 4개의 IP주소와 마지막 1개의 IP주소는 AWS에 의해 내부적으로 사용되기 때문에 우리가 사용할 수 없다. 만약 서브넷의 CIDR이 `192.168.0.0/24`이라면 `192.168.0.0`, `192.168.0.1`, `192.168.0.2`, `192.168.0.3`, `192.168.0.255`는 사용할 수 없다는 것이다.

3. 라우팅 테이블

    네트워크 트래픽을 어느 곳으로 전달할지 결정하기 위해 사용된다. 라우팅 테이블에는 라우팅 규칙이 포함된다. 라우팅 테이블은 특정 서브넷에 연결(associate)될 수 있다.

4. 인터넷 게이트웨이

    VPC 내의 리소스들이 인터넷과 통신하기 위해 VPC에 연결되는 게이트웨이이다. 퍼블릭 서브넷에 위치한 리소스들은 인터넷 게이트웨이를 통해 외부와 통신한다.

5. NAT 게이트웨이

    NAT은 네트워크 주소 변환이라는 의미이다. NAT 게이트웨이는 네트워크 주소 변환을 통해 외부와 단절되어 있는 프라이빗 서브넷의 리소스들이 외부와 통신할 수 있게 해준다. NAT 게이트웨이는 퍼블릭 서브넷에 연결된다.

6. Security Group

    EC2 인스턴스 레벨에 적용되는 방화벽 서비스로, 인스턴스에 대한 인바운드, 아웃바운드 규칙을 정의하고 있다. 허용 규칙만 지원하기 때문에 VPC 내부로의 통신을 허용할 네트워크 트래픽에 대한 명시적 허용 규칙이 정의되어야 한다. 허용되지 않은 모두 IP는 거부된다.

    또한 `Stateful`이라는 특성을 가지고 있기 때문에 Inbound 규칙으로 이미 허용된 트래픽은 Outbound 규칙에서 허용하고 있지 않더라도 통과된다.

7. Network ACL (NACL)

    이는 서브넷 레벨에 적용되는 방화벽 서비스이다. Security Group과 달리 허용 규칙과 거부 규칙을 모두 정의할 수 있다. 또한 `Steteless` 특성을 가지고 있어서 Inbound 규칙에서 허용했더라도 Outbound 규칙에서 허용하지 않으면 해당 트래픽은 외부로 나갈 수 없다.

8. VPC 엔드포인트

    VPC 내부의 인스턴스가 VPC 외부의 AWS 서비스와 통신하기 위해서는 인터넷 게이트웨이, NAT 게이트웨이가 반드시 필요했다. 하지만 VPC 엔드포인트를 이용하게 되면 VPC 내의 인스턴스가 퍼블릭 IP를 가지고 있지 않더라도 외부 서비스에 비공개로 연결할 수 있다. 이때 모든 트래픽은 아마존의 내부망을 통하기 때문에 외부에 노출될 위험이 없다는 장점이 있다.

<br/>

# 퍼블릭 서브넷 vs 프라이빗 서브넷

![image](https://github.com/Ohjiwoo-lab/TIL/assets/74577768/7926a57f-3f74-403a-8d74-1e110a539036)

AWS에서 제공하는 독립적인 네트워크 공간인 VPC에는 Public subnet과 Private subnet이 있다. 퍼블릭 서브넷의 경우 외부 인터넷과 통신할 수 있는 서브넷이지만, 프라이빗 서브넷은 외부와 통신할 수 없다.

## 퍼블릭 서브넷

퍼블릭 서브넷이 외부와 통신할 수 있게 하는 방법은 바로 인터넷 게이트웨이를 이용하는 것이다.

![image](https://github.com/Ohjiwoo-lab/TIL/assets/74577768/e327e1fe-c135-4dc3-87aa-fc557a24adf0)

이는 퍼블릭 서브넷의 라우팅 테이블이다. 만약 퍼블릭 서브넷에 위치한 인스턴스로부터 VPC 내부의 다른 서비스로 보내는 요청이 아닌 외부로 보내는 요청이라면 `인터넷 게이트웨이`를 통하도록 설정해놓았다. 이와 반대로 외부에서 퍼블릭 서브넷에 위치한 인스턴스로 요청이 들어올 경우도 마찬가지로 인터넷 게이트웨이를 통하여 요청이 전달된다. 퍼블릭 서브넷 내에 위치한 인스턴스는 퍼블릭 IP를 가질 수 있기 때문에 본인의 퍼블릭 IP를 이용하여 외부와 통신할 수 있다.

> 퍼블릭 서브넷은 인터넷 게이트웨이가 연결된 서브넷을 뜻한다. 따로 퍼블릭 서브넷을 지정하는 것은 아니다.

## 프라이빗 서브넷

그러면 프라이빗 서브넷은 아예 외부와 통신이 불가능할까? 그것은 아니다.

![image](https://github.com/Ohjiwoo-lab/TIL/assets/74577768/614d2df0-7cb8-4911-8db2-628b071efe1c)

이는 프라이빗 서브넷의 라우팅 테이블이다. 마찬가지로 외부로 보내는 요청의 경우 어떠한 것으로 라우팅하도록 설정되어 있는데, 이는 `NAT 게이트웨이`이다. NAT 게이트웨이는 퍼블릭 서브넷에 위치하고 있고, 프라이빗 서브넷의 요청을 외부로 전달하는 역할을 맡고 있다. NAT 게이트웨이 덕분에 프라이빗 서브넷의 인스턴스는 외부 인터넷과 통신할 수 있다.

프라이빗 서브넷 내의 인스턴스는 퍼블릭 IP를 가질 수 없기 때문에, 퍼블릭 IP를 가지고 있는 NAT 게이트웨이로 요청을 보낸다. 그러면 NAT 게이트웨이는 퍼블릭 서브넷의 라우팅 테이블에 의해 인터넷 게이트웨이로 요청을 전달하게 된다. 결국 프라이빗 서브넷에 인스턴스 개수가 무수히 많더라도 동일한 NAT 게이트웨이를 통해 외부로 전달되기 때문에 외부에서는 동일한 IP로 인식하게 된다.

> 프라이빗 서브넷은 NAT 게이트웨이를 통해 외부와 통신한다.

## 배스천 호스트

그러면 외부에서는 프라이빗 서브넷 내의 인스턴스로 어떻게 접속할 수 있을까?

그것은 `배스천 호스트`를 이용할 수 있다. 배스천 호스트는 퍼블릭 서브넷에 위치한 EC2 인스턴스로, 퍼블릭 IP를 가지고 있다. 그리고 프라이빗 서브넷의 인스턴스는 이 배스천 호스트로부터 오는 요청만을 허용한다.

그러면 외부에서 배스천 호스트의 퍼블릭 IP로 접속한 뒤, 배스천 호스트를 통해 프라이빗 서브넷으로 접속할 수 있다. 아무나 접속할 수 없도록 키 페어를 적절히 관리할 필요가 있다.

보안그룹은 다음과 같이 설정할 수 있다.

**배스천 호스트의 보안그룹**

![image](https://github.com/Ohjiwoo-lab/TIL/assets/74577768/27dad1d6-e987-4fae-95d9-24517a06512f)

- 모든 곳에서 SSH 접근을 허용한다.
- 대신 SSH를 위한 키 페어를 보안에 유의하여 관리해야 한다.

**프라이빗 서브넷에 위치한 인스턴스의 보안그룹**

![image](https://github.com/Ohjiwoo-lab/TIL/assets/74577768/4bab014d-6da5-4572-b3ca-2b58299e18ca)

- 배스천 호스트의 보안그룹에 해당하는 곳으로 부터 온 SSH 요청만을 허용한다.
- 위의 사진에서 소스 위치에 `sg-`로 시작하는 것이 배스천 호스트의 보안 그룹이다.
- 이렇게 하면 해당 인스턴스는 반드시 배스천 호스트를 거쳐야만 접속할 수 있다.

> 배스천 호스트보다 SSM Session Manager를 이용하면 SSH 연결이 없더라도 인스턴스에 대한 원격 제어가 가능하다고 한다. 이것을 이용하면 훨씬 보안 상의 이점이 있을 것이다.

<br/>

# Reference

[처음 시작하는 Infrastructure as Code: AWS & 테라폼](https://www.inflearn.com/course/%EB%8D%B0%EB%B8%8C%EC%98%B5%EC%8A%A4-%ED%85%8C%EB%9D%BC%ED%8F%BC-aws)

# History

📌 2024-2-12: 서브넷에서의 통신 방식 정리   
📌 2024-3-3: 퍼블릭 서브넷, 프라이빗 서브넷 통신 방식 추가 정리   
📌 2024-3-4: 테라폼 강의에서 VPC 내용 발췌   
📌 2024-4-5: CIDR 블록과 Network ACL (NACL) 내용 추가   